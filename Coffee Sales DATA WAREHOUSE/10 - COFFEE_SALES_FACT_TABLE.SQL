CREATE TABLE COFFEE_SALES_FACT_TABLE(
	DIM_CUSTOMER_ID INT NOT NULL FOREIGN KEY REFERENCES DIM_CUSTOMER(DIM_CUSTOMER_ID) ON DELETE CASCADE ON UPDATE CASCADE,
	DIM_ORDER_ID INT NOT NULL FOREIGN KEY REFERENCES DIM_ORDER(DIM_ORDER_ID) ON DELETE CASCADE ON UPDATE CASCADE,
	DIM_PRODUCT_ID INT NOT NULL FOREIGN KEY REFERENCES DIM_PRODUCT(DIM_PRODUCT_ID) ON DELETE CASCADE ON UPDATE CASCADE,
	UNIT_SIZE INT NOT NULL,
	REVENUE DECIMAL(5,2) NOT NULL,
	COST DECIMAL(5,2) NOT NULL,
	PROFIT AS CAST(REVENUE - COST AS DECIMAL(5,2))
)

INSERT INTO COFFEE_SALES_FACT_TABLE
SELECT
	CUSTOMER_ID AS DIM_CUSTOMER_ID,
	A.ORDER_ID AS DIM_ORDER_ID,
	B.PRODUCT_ID AS DIM_PRODUCT_ID,
	UNIT_SIZE,
	UNIT_PRICE,
	CAST(COST_PER_100G / (100 / CAST(UNIT_SIZE AS FLOAT)) AS DECIMAL(5,2))

FROM COFFEE_SALES.DBO.[ORDER] A
INNER JOIN COFFEE_SALES.DBO.ORDER_LINE B ON A.ORDER_ID = B.ORDER_ID
INNER JOIN COFFEE_SALES.DBO.PRODUCT C ON B.PRODUCT_ID = C.PRODUCT_ID
WHERE NOT EXISTS(
	SELECT 1
	FROM COFFEE_SALES_FACT_TABLE
	WHERE A.CUSTOMER_ID = DIM_CUSTOMER_ID
	AND A.ORDER_ID = DIM_ORDER_ID
	AND B.PRODUCT_ID = DIM_PRODUCT_ID
)